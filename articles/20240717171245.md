---
title: "Cloud Build ã§ CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ã¿ãŸ"
emoji: "ğŸ“"
type: "tech"
topics: ["GCP", "terraform"]
published: false
publication_name: hogeticlab
---

## ã¯ã˜ã‚ã«
Hogetic Lab ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹ä½ã€…æœ¨ã¨ç”³ã—ã¾ã™ã€‚

ç¾åœ¨ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®ç’°å¢ƒã§ã¯ã€æ–°æ©Ÿèƒ½ã‚„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€ãƒã‚°ä¿®æ­£ã‚’è¿…é€Ÿã‹ã¤ç¢ºå®Ÿã«ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å±Šã‘ã‚‹èƒ½åŠ›ãŒé‡è¦ã§ã™ã€‚Continuous Deploymentï¼ˆCDï¼‰ã¯ã€ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã—ã€ã‚³ãƒ¼ãƒ‰ãŒãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ãŸã³ã«è‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†æ‰‹æ³•ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¿¡é ¼æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«ã¯å¿…é ˆã®æ©Ÿèƒ½ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
å‰å› ã€Œ[API ãƒ†ã‚¹ãƒˆã‚’ Scenarigo ã¨ GitHub Actions ã§è‡ªå‹•åŒ–ã™ã‚‹](https://zenn.dev/hogeticlab/articles/9b420653190190)ã€ ã®è¨˜äº‹ã®ç¶šãã«ãªã‚Šã¾ã™ã€‚

ãã‚Œã§ã¯æ—©é€Ÿæ§‹ç¯‰ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼
ä»Šå›ã¯ terraform ã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ã¦ã„ã¾ã™ã€‚

## æ¦‚è¦
1. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒåŠã³ DB ã®ä½œæˆ**
    * **VPC**, **Subnet**, **Private Service Access**
2. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®æ§‹ç¯‰**
    * **Artifact Registry**, **Serverless VPC Access**, **Cloud Run**
3. **CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰**
    * **Secret Manager**, **Cloud Build**

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒåŠã³ DB ã®ä½œæˆ
* **Private Service Access** ã¨ã¯
    * GCP ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æŠœç²‹
        1. [ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä½¿ç”¨ã—ã€Google Cloud ã‚„ Googleã€ã¾ãŸã¯ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¤–éƒ¨ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚Šå½“ã¦ãšã«ã€ç‰¹å®šã® Google ã‚„ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã—ã¾ã™ã€‚](https://cloud.google.com/vpc/docs/private-access-options?hl=ja&_gl=1*1h0cwvv*_ga*MzM3MDIwNTcyLjE3MTIxMzczNzM.*_ga_WH2QY8WWF5*MTcyMTI2OTkzOC4yNTguMS4xNzIxMjcwMDUwLjAuMC4w#connect-services)
        2. [ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯ã€ã¾ãšå†…éƒ¨ IPv4 ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ã‚’å‰²ã‚ŠæŒ¯ã‚Šã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæ¥ç¶šã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚](https://cloud.google.com/vpc/docs/private-access-options?hl=ja)
    * Cloud SQL ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¤–éƒ¨ IP ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãªã Cloud Run ã‹ã‚‰å®‰å…¨ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã­!

```
resource "google_compute_network" "network" {
  name                    = "network"
  auto_create_subnetworks = false
}

resource "google_compute_subnetwork" "subnet" {
  name          = "subnet"
  ip_cidr_range = "192.168.0.0/24"
  network       = google_compute_network.network.id

  depends_on = [google_compute_network.network]
}

// * å†…éƒ¨ IPv4 ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ã‚’å‰²ã‚ŠæŒ¯ã‚‹
// https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_global_address
resource "google_compute_global_address" "private_ip" {
  name          = "private-ip"
  purpose       = "VPC_PEERING"
  address_type  = "INTERNAL"
  prefix_length = "16"
  network       = google_compute_network.network.id

  depends_on = [google_compute_network.network]
}

// * ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæ¥ç¶šã‚’ä½œæˆã™ã‚‹
// https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/service_networking_connection
resource "google_service_networking_connection" "connection" {
  network                 = google_compute_network.network.id
  service                 = "servicenetworking.googleapis.com"
  reserved_peering_ranges = [google_compute_global_address.private_ip.name]
  deletion_policy         = "ABANDON"

  depends_on = [google_compute_global_address.private_ip]
}

resource "google_sql_database_instance" "db_instance" {
  name             = "db-instance"
  database_version = "POSTGRES_13"
  region           = var.region

  settings {
    tier = "db-f1-micro"
    ip_configuration {
      ipv4_enabled    = false
      private_network = google_compute_network.network.id
    }
  }

  deletion_protection = false
  depends_on          = [google_service_networking_connection.connection]
}
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®æ§‹ç¯‰
* **Serverless VPC Access** ã¨ã¯
    * GCP ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æŠœç²‹
        [ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ VPC ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Cloud Functionsã€Cloud Runï¼ˆãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ï¼‰ã‚µãƒ¼ãƒ“ã‚¹ã€App Engine ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ç’°å¢ƒã‚¢ãƒ—ãƒªã§ã€ã“ã‚Œã‚‰ã®ãƒªã‚½ãƒ¼ã‚¹ã®å†…éƒ¨ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ã£ã¦ VPC ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚](https://cloud.google.com/vpc/docs/configure-serverless-vpc-access?hl=ja&_gl=1*b4zft7*_ga*MzM3MDIwNTcyLjE3MTIxMzczNzM.*_ga_WH2QY8WWF5*MTcyMTI2OTkzOC4yNTguMS4xNzIxMjcwODg0LjU5LjAuMA..)
    * Cloud Run ã¯ VPC ãƒªã‚½ãƒ¼ã‚¹ã§ã¯ãªã„ã®ã§ã€ä¸Šè¿°ã® **Private Service Access** ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯ VPC ã«æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã­!
```
resource "google_artifact_registry_repository" "repository" {
  repository_id = "repository"
  format        = "DOCKER"
  location      = var.region
}

// Serverless VPC Access Connector ã‚’ä½œæˆã™ã‚‹
// https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/vpc_access_connector
resource "google_vpc_access_connector" "connector" {
  name          = "serverless-vpc-connector"
  ip_cidr_range = "192.168.1.0/28"
  network       = google_compute_network.network.name

  depends_on = [google_compute_network.network]
}

resource "google_cloud_run_service" "service" {
  name     = "service"
  location = var.region

  template {
    spec {
      containers {
        image = "${var.region}-docker.pkg.dev/${var.project}/${google_artifact_registry_repository.repository.repository_id}/application:latest"

        env {
          name  = "DB_HOST"
          // Cloud SQL ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã™ã‚‹
          value = google_sql_database_instance.db_instance.private_ip_address
        }
        ...
      }
    }

    metadata {
      annotations = {
        "run.googleapis.com/vpc-access-egress"    = "all-traffic"
        // ä¸Šã§ä½œæˆã—ãŸ VPC Access Connector ã‚’æŒ‡å®šã™ã‚‹
        "run.googleapis.com/vpc-access-connector" = google_vpc_access_connector.connector.name
      }
    }
  }

  traffic {
    percent         = 100
    latest_revision = true
  }
}
```

### CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰
* ä»Šå›ã¯ Github Actions ã§ CI ã‚’å®Ÿè¡Œã—ã€ main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§**ãƒ“ãƒ«ãƒ‰**, **ãƒ‡ãƒ—ãƒ­ã‚¤**ã‚’ **Cloud Build Trigger** ãŒè¡Œã†æ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚
* å‰ææ¡ä»¶
    * Github ã¨ Cloud Build ãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹ã€‚[å‚è€ƒURL](https://cloud.google.com/build/docs/automating-builds/github/connect-repo-github?hl=ja)
    * Github Token ã‚’å–å¾—ã—ã¦ã„ã‚‹
```
// Github Token ã‚’ä¿å­˜ã™ã‚‹ Secret Manager ã‚’ç”¨æ„ã™ã‚‹
resource "google_secret_manager_secret" "sm" {
  secret_id = "github-token"

  replication {
    auto {}
  }
}

resource "google_secret_manager_secret_version" "smv" {
  secret      = google_secret_manager_secret.sm.id
  // å‰ææ¡ä»¶ã§å–å¾—ã—ã¦ã„ã‚‹ Github ã®ãƒˆãƒ¼ã‚¯ãƒ³
  secret_data = var.github_token

  depends_on = [google_secret_manager_secret.sm]
}

data "google_iam_policy" "secretAccessor" {
  binding {
    role    = "roles/secretmanager.secretAccessor"
    members = ["serviceAccount:service-${var.project_id}@gcp-sa-cloudbuild.iam.gserviceaccount.com"]
  }
}

resource "google_secret_manager_secret_iam_policy" "policy" {
  secret_id   = google_secret_manager_secret.sm.secret_id
  policy_data = data.google_iam_policy.secretAccessor.policy_data

  depends_on = [google_secret_manager_secret_version.smv]
}

resource "google_cloudbuildv2_connection" "connection" {
  location = var.region
  name     = "connection"

  github_config {
    // Github ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ Cloud Build ã® installation id ã‚’å–å¾—ã™ã‚‹ã€‚
    app_installation_id = var.installation_id
    authorizer_credential {
      // ä¸Šã§ä½œæˆã—ãŸ Github Token ã‚’ä¿å­˜ã—ãŸéš›ã® Secret Manager ã® ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ID ã‚’æŒ‡å®šã—ã¾ã™ã€‚
      oauth_token_secret_version = google_secret_manager_secret_version.smv.id
    }
  }

  depends_on = [google_secret_manager_secret_iam_policy.policy]
}

resource "google_project_iam_member" "attach_permissions" {
  // https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/cloudbuild_trigger#example-usage---cloudbuild-trigger-service-account
  // ä¸Šè¨˜ãƒªãƒ³ã‚¯ã‚’å‚è€ƒã«ä»Šå›ã¯ Cloud Build Trigger ã‹ã‚‰ Cloud Run ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã§æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã—ãŸã€‚
  for_each = toset([
    "roles/run.admin",
    "roles/logging.logWriter",
    "roles/iam.serviceAccountUser",
  ])
  role    = each.key
  project = var.project
  member  = "serviceAccount:${var.project_id}@cloudbuild.gserviceaccount.com"
}

resource "google_cloudbuild_trigger" "trigger" {
  name = "trigger"

  // github ã®é–¢é€£è¦ç´ ã‚’æŒ‡å®š
  github {
    owner = var.github_owner
    name  = var.github_repository
    push {
      branch = "^main$"
    }
  }

  filename   = "cloudbuild.yml"
  depends_on = [google_cloudbuildv2_connection.connection]
}
```

### ãŠã¾ã‘
* **cloudbuild.yml**
    * ç‰¹ç­†ã™ã¹ãã“ã¨ã¯ã‚ã¾ã‚Šãªã„ã§ã™ãŒã€ docker ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã«ã¯ commit ãƒãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¾ã—ã‚‡ã†!
```
steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-f', 'docker/Dockerfile', '-t', 'asia-northeast1-docker.pkg.dev/${PROJECT_ID}/repository/application:${COMMIT_SHA}', '.']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'asia-northeast1-docker.pkg.dev/${PROJECT_ID}/repository/application:${COMMIT_SHA}']
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args:
  - 'run'
  - 'deploy'
  - 'service'
  - '--image'
  - 'asia-northeast1-docker.pkg.dev/${PROJECT_ID}/repository/application:${COMMIT_SHA}'
  - '--region'
  - 'asia-northeast1'
```

## ã¾ã¨ã‚
* ä»Šå›åˆã‚ã¦ GCP ã§ CI/CD ã‚’çµ„ã‚“ã§ã¿ã¾ã—ãŸãŒã€**Cloud Build Trigger** ã®æ§‹ç¯‰ã¯éå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ãã€ã‚·ãƒ³ãƒ—ãƒ«ã ã¨æ„Ÿã˜ã¾ã—ãŸã€‚
* ã¾ãŸ **Cloud Run** ã¯æœ€å¤§åŒæ™‚å®Ÿè¡Œæ•°ã‚’ 0 ã«è¨­å®šã§ãã‚‹ã®ã§ **æ¦‚å¿µæ¤œè¨¼ã®æ®µéš** ã‚„ **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ** ã‚„ **ãƒ†ã‚¹ãƒˆç’°å¢ƒ** ãªã©ã§ä½¿ç”¨ã™ã‚‹ã¨ã‚³ã‚¹ãƒˆé¢ã§éå¸¸ã«å„ªç§€ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚
* [ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰](https://github.com/teppeisasaki-hl/cicd)
