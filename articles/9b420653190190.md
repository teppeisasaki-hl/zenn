---
title: "API ãƒ†ã‚¹ãƒˆã‚’ Scenarigo ã¨ GitHub Actions ã§è‡ªå‹•åŒ–ã™ã‚‹"
emoji: "ğŸ“"
type: "tech"
topics: ["GitHub", "Test", "Go"]
published: true
publication_name: "hogeticlab"
---

## ã¯ã˜ã‚ã«
Hogetic Lab ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹ä½ã€…æœ¨ã¨ç”³ã—ã¾ã™ã€‚

API ãƒ†ã‚¹ãƒˆã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ä¸å¯æ¬ ãªãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚ç‰¹ã«ã€è¤‡é›‘ãªã‚·ã‚¹ãƒ†ãƒ ã‚„å¤šãã®ä¾å­˜é–¢ä¿‚ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€æ‰‹å‹•ã§ã®ãƒ†ã‚¹ãƒˆã¯æ™‚é–“ã¨åŠ´åŠ›ãŒã‹ã‹ã‚Šã¾ã™ã€‚å¼Šç¤¾ã§ã¯ API ã®ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ [Scenarigo](https://github.com/zoncoen/scenarigo) ã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€Scenarigo ã‚’ä½¿ç”¨ã—ã¦ API ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã€GitHub Actions ã‚’ä½¿ã£ã¦ CI ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ±åˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

## Scenarigo ã¨ã¯ï¼Ÿ
Scenarigo ã¯ã€YAML å½¢å¼ã®ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ API ãƒ†ã‚¹ãƒˆã‚’ç°¡å˜ã«è¨˜è¿°ãƒ»å®Ÿè¡Œã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ä¸»ãªç‰¹å¾´ã¨ã—ã¦ä»¥ä¸‹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

### é¸å®šç†ç”±
1. ã‚·ãƒŠãƒªã‚ªãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ:
ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’ YAML ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€ç›´æ„Ÿçš„ã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç®¡ç†ã§ãã¾ã™ã€‚

2. å°å…¥ã®å®¹æ˜“ã•:
Scenarigoã¯ã€Postmanãªã©ã®ä»–ãƒ„ãƒ¼ãƒ«ã¨æ¯”è¼ƒã—ã¦ã€CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¸ã®çµ±åˆãŒå®¹æ˜“ã§ã™ã€‚ã¾ãŸã€YAMLã§ã‚·ãƒ³ãƒ—ãƒ«ã«è¨˜è¿°ã§ãã‚‹ãŸã‚å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ãã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å†åˆ©ç”¨ã‚‚å¯èƒ½ã§ã™ã€‚ã“ã‚Œã‚‰ã®ç‚¹ã‹ã‚‰ã€ä»–ã®ãƒ„ãƒ¼ãƒ«ã«æ¯”ã¹ã¦é­…åŠ›çš„ã§ã™ã€‚

3. Goè¨€èªã¨ã®è¦ªå’Œæ€§:
Scenarigoã¯Goè¨€èªã§æ›¸ã‹ã‚Œã¦ãŠã‚Šã€Goã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨è‡ªç„¶ã«çµ±åˆã§ãã¾ã™ã€‚ãã®ãŸã‚ã€Goã§é–‹ç™ºã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é©ã—ã¦ã„ã¾ã™ã€‚

4. æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:
ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã€Scenarigoã¯æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›ã—ã¾ã™ã€‚ãã®ãŸã‚ã€ã©ã“ã§ä½•ãŒé–“é•ã£ã¦ã„ã‚‹ã®ã‹ã‚’è¿…é€Ÿã«ç‰¹å®šã§ãã€ãƒ‡ãƒãƒƒã‚°ãŒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
Scenarigo ã¯ Go è¨€èªã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€Go ã®é–‹ç™ºç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```sh
go install github.com/zoncoen/scenarigo/cmd/scenarigo@latest
```

### ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
YAML å½¢å¼ã§ã‚·ãƒŠãƒªã‚ªã‚’è¨˜è¿°ã—ã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã®ç°¡å˜ãªæŠœç²‹ã§ã™ã€‚
```
title: user test # ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã®ã‚¿ã‚¤ãƒˆãƒ«
vars: 
  url: http://localhost:9000/v1 # ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹åŸºæœ¬URLã‚’å¤‰æ•°ã¨ã—ã¦å®šç¾©
steps: 
  - title: create user # ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã®ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒƒãƒ—
    protocol: http # ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯ HTTP
    request: 
      method: POST # HTTP ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒ‡å®š
      url: "{{vars.url}}/users"
      header: 
        Content-Type: application/json # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ã€JSON å½¢å¼ã‚’æŒ‡å®š
      body: 
        name: testname # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’è¨­å®š
    expect: 
      code: OK # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ãŒOK(200)ã§ã‚ã‚‹ã“ã¨ã‚’æœŸå¾…
      body: 
        id: '{{int($) > 0}}' # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã® id ãŒ0ã‚ˆã‚Šå¤§ãã„æ•´æ•°ã§ã‚ã‚‹ã“ã¨ã‚’æœŸå¾…
        name: "{{request.body.name}}" # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã® name ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã® name ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’æœŸå¾…
    bind: 
      # è¿”ã‚Šå€¤ãªã©ã‚’å¤‰æ•°ã¨ã—ã¦ãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ã€‚
      vars: 
        user_id: '{{response.body.id}}'
        user_name: '{{response.body.name}}'
  - title: get user
    protocol: http
    request: 
      method: GET
      url: "{{vars.url}}/users/{{int(vars.user_id)}}" # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸ user_id ã‚’è¨­å®š
      header: 
        Content-Type: application/json
    expect: 
      code: OK
      body: 
        id: '{{int(vars.user_id)}}' # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã® id ãŒãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸ user_id ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’æœŸå¾…
        name: '{{vars.user_name}}' # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã® name ãŒãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸ user_name ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’æœŸå¾…
```

### plugin ã®ä½œæˆ
plugin ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆã‚’æ‹¡å¼µã—æ¨™æº–ã®æ©Ÿèƒ½ã§ã¯å¯¾å¿œã§ããªã„ã‚±ãƒ¼ã‚¹ã«æŸ”è»Ÿã«å¯¾å¿œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»Šå›ã¯ uuid ã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

* ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
```
root/
â”œâ”€â”€ scenarigo/
â”‚   â””â”€â”€ scenarigo.yaml
â”‚   â””â”€â”€ user.yaml
â”‚   â””â”€â”€ plugins
â”‚       â””â”€â”€ uuid
â”‚           â””â”€â”€ main.go
â”‚   â””â”€â”€ gen
â”‚       â””â”€â”€ uuid.so
```

* scenarigo/plugins/uuid/main.go
```
package main

import "github.com/google/uuid"

func New() string {
	return uuid.New().String()
}
```

* scenarigo/scenarigo.yaml
* `cd scenarigo && scenarigo plugin build` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
```
schemaVersion: config/v1

scenarios:
  - user.yaml

pluginDirectory: ./gen 
plugins:               
  uuid.so: # scenarigo plugin build ã§ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š 
    src: ./plugins/uuid

output:
  verbose: false
```

* scenarigo/user.yaml
```
title: user test
plugins:
  uuid: uuid.so # scenarigo plugin build ã§ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
vars:
  url: http://localhost:9000/v1
steps:
...
    body: 
      name: '{{plugins.uuid.New()}}' # uuid/main.go ã§è¨­å®šã—ãŸé–¢æ•°åã‚’ä½¿ç”¨
...
```

## GitHub Actions ã® CI ç’°å¢ƒ
GitHub Actions ã¯ã€GitHub ãƒªãƒã‚¸ãƒˆãƒªã«å¯¾ã—ã¦è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸéš›ã«è‡ªå‹•ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰ã€CI ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¯é‡è¦ã§ã™ã€‚

1. **ç¶™ç¶šçš„ãªå“è³ªä¿è¨¼**: ã‚³ãƒ¼ãƒ‰ãŒãƒªãƒã‚¸ãƒˆãƒªã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ãŸã³ã«è‡ªå‹•ã§ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€å¸¸ã«æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚
2. **æ—©æœŸã®ãƒã‚°æ¤œå‡º**: å¤‰æ›´ãŒåŠ ãˆã‚‰ã‚ŒãŸéš›ã«å³åº§ã«ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ãƒã‚°ã‚’æ—©æœŸã«æ¤œå‡ºã—ã€ä¿®æ­£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
3. **ä¸€è²«æ€§ã®ç¢ºä¿**: æ‰‹å‹•ãƒ†ã‚¹ãƒˆã§ã¯ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã‚„ã™ã„ã§ã™ãŒã€è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã¯ä¸€è²«ã—ã¦åŒã˜æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ä¿¡é ¼æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚
4. **åŠ¹ç‡ã®å‘ä¸Š**: è‡ªå‹•ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šã€é–‹ç™ºè€…ã¯æ‰‹å‹•ãƒ†ã‚¹ãƒˆã«è²»ã‚„ã™æ™‚é–“ã‚’å‰Šæ¸›ã§ãã€ãã®åˆ†é–‹ç™ºã‚„ä»–ã®é‡è¦ãªã‚¿ã‚¹ã‚¯ã«é›†ä¸­ã§ãã¾ã™ã€‚

### GitHub Actions ã§ã® Scenarigo ãƒ†ã‚¹ãƒˆã®è¨­å®šä¾‹
ä»¥ä¸‹ã¯ã€GitHub Actions ã‚’ä½¿ã£ã¦ Scenarigo ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ç°¡å˜ãªè¨­å®šä¾‹ã§ã™ã€‚

```
name: ci

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go-version: ['1.22.x']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}

    - name: run container
      run: docker-compose up -d

    - name: run test
      run: make test
```

ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚ŒãŸã¨ãã« Scenarigo ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã€å•é¡ŒãŒãªã„ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

## ã¾ã¨ã‚
API ãƒ†ã‚¹ãƒˆã®è‡ªå‹•åŒ–ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«éå¸¸ã«é‡è¦ã§ã™ã€‚Scenarigo ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚·ãƒŠãƒªã‚ªãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆã‚’ç°¡å˜ã«ä½œæˆãƒ»å®Ÿè¡Œã§ãã€GitHub Actions ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ±åˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç¶™ç¶šçš„ãªå“è³ªä¿è¨¼ã€æ—©æœŸã®ãƒã‚°æ¤œå‡ºã€ä¸€è²«æ€§ã®ç¢ºä¿ã€åŠ¹ç‡ã®å‘ä¸Šã‚’å®Ÿç¾ã§ãã¾ã™ã€‚
æ¬¡å›ã¯ CD ã®æ§‹ç¯‰ã‚’è¡Œã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
[ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰](https://github.com/teppeisasaki-hl/test)
